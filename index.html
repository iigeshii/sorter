<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barn Sorter Item Directory</title>
  <style>
    :root{
      --bg:#070b12;
      --card:#0b1220;
      --border:rgba(255,255,255,.08);
      --text:#e7eefc;
      --muted:rgba(231,238,252,.6);
      --muted2:rgba(231,238,252,.45);
      --accent:rgba(122,162,255,.9);
      --shadow: 0 12px 50px rgba(0,0,0,.55);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 800px at 25% 0%, rgba(122,162,255,.10), transparent 60%),
                  radial-gradient(900px 700px at 85% 20%, rgba(45,212,191,.08), transparent 60%),
                  var(--bg);
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 24px;
    }

    header{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom: 12px;
    }

    .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size: 18px;
      line-height:1.15;
    }
    .subtitle{
      margin-top:2px;
      font-size: 12px;
      color:var(--muted);
    }

    .searchRow{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
      flex:1;
      max-width: 640px;
    }
    .search{
      flex:1;
      height: 36px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 0 12px;
      outline:none;
    }
    .btn{
      height: 36px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 0 12px;
      cursor:pointer;
      font-weight:700;
    }
    .btn:hover{ border-color: rgba(122,162,255,.35); }

    .grid{
      display:grid;
      grid-template-columns: 1.55fr 1fr;
      gap:14px;
      align-items:stretch;
    }

    .card{
      border:1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    .cardHead .label{
      font-size: 11px;
      color: var(--muted);
      letter-spacing:.08em;
    }
    .pill{
      margin-left:auto;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    /* CSV fallback loader */
    .loaderBox{
      padding: 10px 12px 0;
    }
    .notice{
      border:1px solid var(--border);
      background: rgba(122,162,255,.07);
      color: var(--muted);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .pickerRow{
      display:none;
      gap:10px;
      align-items:center;
      padding-bottom: 8px;
    }
    .pickerRow.show{ display:flex; }
    .file{
      flex:1;
      color: var(--muted);
      font-size: 12px;
    }
    input[type="file"]{
      width: 260px;
      max-width: 55vw;
      color: var(--muted);
      font-size: 12px;
    }

    /* Table */
    .tableWrap{ padding: 10px 0 0; }
    table{ width:100%; border-collapse: collapse; font-size: 13px; }
    thead th{
      text-align:left;
      padding: 10px 12px;
      font-size: 11px;
      color: var(--muted);
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.12);
      user-select:none;
      cursor:pointer;
    }
    thead th .arrow{ opacity:.6; margin-left:6px; font-family:var(--mono); }
    tbody td{
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color: rgba(231,238,252,.92);
      vertical-align:middle;
    }
    tbody tr{ cursor:pointer; }
    tbody tr:hover{ background: rgba(122,162,255,.08); }
    tbody tr.active{
      background: rgba(122,162,255,.14);
      outline: 1px solid rgba(122,162,255,.30);
    }

    .tag{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid rgba(45,212,191,.22);
      background: rgba(45,212,191,.10);
      color: rgba(45,212,191,.95);
      font-size: 11px;
      line-height:1.2;
      white-space: nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .mono{ font-family: var(--mono); }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }

    /* Map panel */
    .mapPanel{ padding-bottom: 8px; }
    .mapBody{ padding: 10px 12px 12px; }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    /* === Table-style barn layout (Excel-like) === */
    .tableMap{
      display:grid;
      grid-template-columns: 84px 1fr 84px;  /* East rail / center / West rail */
      grid-template-rows: auto 1fr;          /* South row / main area */
      gap:10px;
      min-height: 600px;
    }

    .tableSouth, .tableSide, .tableCenter{
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
    }

    .tableSouth{
      grid-column: 1 / 4;
      padding: 10px 10px 12px;
    }
    .tableSouthHead{
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:.2px;
      margin-bottom:10px;
    }
    .letterRow{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:nowrap;
    }

    .tableSide{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    .letterCol{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      justify-content:center;
      flex:1;
    }
    .sideLabel{
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted2);
      letter-spacing:.08em;
      user-select:none;
    }

    .tableCenter{
      padding: 12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:10px;
      min-width: 0;
    }

    .k{
      font-size: 10px;
      color: var(--muted2);
      letter-spacing:.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .mapOverlayTitle{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .centerGrid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 12px;
      align-items:start;
      min-width: 0;
    }

    /* Your existing “nice squares” */
    .colBtn{
      position:relative;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      height: 40px;
      width: 52px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      letter-spacing:.12em;
      cursor:pointer;
      user-select:none;
    }
    .colBtn:hover{ border-color: rgba(122,162,255,.30); background: rgba(122,162,255,.06); }
    .colBtn.active{
      border-color: rgba(122,162,255,.75);
      box-shadow: 0 0 0 3px rgba(122,162,255,.14);
      background: rgba(122,162,255,.12);
    }

    .dot{
      position:absolute;
      width:7px;height:7px;
      border-radius: 999px;
      background: rgba(45,212,191,.95);
      top: 7px;
      right: 9px;
      box-shadow: 0 0 0 3px rgba(45,212,191,.12);
      opacity:0;
    }
    .colBtn.hasItems .dot{ opacity:1; }

    /* Locator */
    .locator{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-start;
    }
    .locBlock{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .locTitle{
      font-size: 10px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .miniGrid{
      display:grid;
      grid-template-columns: repeat(3, 18px);
      grid-auto-rows: 18px;
      gap: 5px;
    }
    .miniCell{
      border:1px solid var(--border);
      border-radius: 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 10px;
      font-family: var(--mono);
      color: var(--muted);
      background: rgba(255,255,255,.02);
    }
    .miniCell.on{
      color: var(--text);
      border-color: rgba(122,162,255,.9);
      background: rgba(122,162,255,.14);
      box-shadow: 0 0 0 3px rgba(122,162,255,.14);
    }

    /* Keep everything fitting */
    @media (max-height: 760px){
      .tableMap{ min-height: 540px; }
      .colBtn{ height: 38px; width: 50px; }
      .miniGrid{
        grid-template-columns: repeat(3, 16px);
        grid-auto-rows: 16px;
        gap:4px;
      }
      .miniCell{ border-radius:5px; font-size:9px; }
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .tableMap{ min-height: 540px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Barn Sorter Item Directory</div>
        <div class="subtitle">Search • sort • click an item to highlight its wall column</div>
      </div>

      <div class="searchRow">
        <input id="q" class="search" placeholder="Search (e.g. quartz, prismarine, ladders, G1-5)" autocomplete="off" />
        <button id="clear" class="btn">Clear</button>
      </div>
    </header>

    <div class="grid">
      <!-- DIRECTORY -->
      <div class="card">
        <div class="cardHead">
          <div class="label">DIRECTORY</div>
          <div class="pill"><span id="countNow">0</span> / <span id="countAll">0</span></div>
        </div>

        <div class="loaderBox">
          <div id="notice" class="notice" style="display:none"></div>

          <div id="pickerRow" class="pickerRow">
            <input id="file" type="file" accept=".csv,text/csv" />
            <button id="loadBtn" class="btn">Load CSV</button>
            <div class="file muted">Local file mode only</div>
          </div>

          <div class="muted2" style="font-size:11px;padding:0 2px 8px;">
            On GitHub Pages this loads <span class="mono">items.csv</span> automatically. If you open the file locally, you may need the picker.
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th id="thItem">ITEM <span class="arrow" id="arItem">▲</span></th>
                <th id="thLoc">LOCATION <span class="arrow" id="arLoc"></span></th>
                <th id="thCat">CATEGORY <span class="arrow" id="arCat"></span></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>

      <!-- MAP -->
      <div class="card mapPanel" id="mapPanel">
        <div class="cardHead">
          <div class="label">BARN MAP</div>
          <div class="pill">Enter from North: East ← • South ↑ • West →</div>
        </div>

        <div class="mapBody">
          <div class="hint">Click an item (or a column) to highlight where it lives.</div>

          <!-- Excel-like single table layout -->
          <div class="tableMap" id="tableMap">
            <!-- South Wall -->
            <div class="tableSouth">
              <div class="tableSouthHead">South Wall</div>
              <div class="letterRow" id="southCols"></div>
            </div>

            <!-- East Wall (A bottom, I top) -->
            <div class="tableSide">
              <div class="letterCol" id="eastCols"></div>
              <div class="sideLabel">East Wall</div>
            </div>

            <!-- Center: Selected item -->
            <div class="tableCenter" aria-live="polite">
              <div class="k">Item</div>
              <div class="mapOverlayTitle" id="selDesc2">—</div>

              <div class="centerGrid">
                <div>
                  <div class="k">Chest</div>
                  <div class="mono" id="selChest2">—</div>
                </div>

                <div>
                  <div class="k">Locator</div>
                  <div id="locator2" class="locator"></div>
                </div>
              </div>
            </div>

            <!-- West Wall -->
            <div class="tableSide">
              <div class="letterCol" id="westCols"></div>
              <div class="sideLabel">West Wall</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);

    function colRange(a,b){
      const A=a.charCodeAt(0), B=b.charCodeAt(0);
      const out=[];
      for(let c=A;c<=B;c++) out.push(String.fromCharCode(c));
      return out;
    }

    function normalizeText(s){
      return (s||"")
        .toString()
        .replace(/\s+/g," ")
        .trim();
    }

    function safeLocation(chestID){
      const m = (chestID||"").trim().match(/^([A-Z])(\d+)-(\d+)$/);
      if(!m) return "";
      return `${m[1]}${m[2]}-${m[3]}`;
    }

    function parseCSV(text){
      const rows=[];
      let i=0, field="", row=[], inQ=false;
      const pushField = ()=>{ row.push(field); field=""; };
      const pushRow = ()=>{ rows.push(row); row=[]; };

      while(i<text.length){
        const ch=text[i];
        if(inQ){
          if(ch === '"'){
            if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
            inQ=false; i++; continue;
          }
          field += ch; i++; continue;
        }else{
          if(ch === '"'){ inQ=true; i++; continue; }
          if(ch === ","){ pushField(); i++; continue; }
          if(ch === "\r"){ i++; continue; }
          if(ch === "\n"){ pushField(); pushRow(); i++; continue; }
          field += ch; i++; continue;
        }
      }
      pushField(); pushRow();
      while(rows.length && rows[rows.length-1].every(v => (v||"").trim()==="")) rows.pop();
      return rows;
    }

    function rowsToItems(csvRows){
      if(!csvRows.length) return [];
      const header = csvRows[0].map(h => normalizeText(h));
      const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

      const iDesc = idx("Description");
      const iChest= idx("ChestID");
      const iCol  = idx("Column");
      const iCat  = idx("Categories");

      const iDesc2 = iDesc>=0 ? iDesc : header.findIndex(h=>h.toLowerCase().includes("description"));
      const iChest2= iChest>=0 ? iChest : header.findIndex(h=>h.toLowerCase().includes("chest"));
      const iCol2  = iCol>=0 ? iCol : header.findIndex(h=>h.toLowerCase()==="column");
      const iCat2  = iCat>=0 ? iCat : header.findIndex(h=>h.toLowerCase().includes("categor"));

      const out=[];
      for(let r=1;r<csvRows.length;r++){
        const row=csvRows[r];
        const Description = normalizeText(row[iDesc2] ?? "");
        const ChestID     = normalizeText(row[iChest2] ?? "");
        const Column      = normalizeText(row[iCol2] ?? "");
        const Category    = normalizeText(row[iCat2] ?? "");
        if(!Description || !ChestID) continue;

        out.push({
          Description,
          ChestID,
          Location: safeLocation(ChestID),
          Column: Column || (ChestID[0] || ""),
          Category
        });
      }
      return out;
    }

    function parseChestID(chestID){
      const m = (chestID || "").trim().match(/^([A-Z])(\d+)-(\d+)$/);
      if(!m) return null;
      return { col: m[1], cluster: parseInt(m[2],10), num: parseInt(m[3],10) };
    }

    function renderLocator(chestID, targetId="locator2"){
      const el = $(targetId);
      if(!el) return;

      const p = parseChestID(chestID);
      if(!p || !(p.cluster === 1 || p.cluster === 2) || !(p.num >= 1 && p.num <= 9)){
        el.innerHTML = `<div class="muted">—</div>`;
        return;
      }

      const makeBlock = (title, activeCluster) => {
        const wrap = document.createElement("div");
        wrap.className = "locBlock";

        const t = document.createElement("div");
        t.className = "locTitle";
        t.textContent = title;

        const g = document.createElement("div");
        g.className = "miniGrid";

        for(let n=1; n<=9; n++){
          const c = document.createElement("div");
          c.className = "miniCell" + ((p.cluster === activeCluster && p.num === n) ? " on" : "");
          c.textContent = n;
          g.appendChild(c);
        }

        wrap.appendChild(t);
        wrap.appendChild(g);
        return wrap;
      };

      el.innerHTML = "";
      el.appendChild(makeBlock(`${p.col}1 (Top)`, 1));
      el.appendChild(makeBlock(`${p.col}2 (Bottom)`, 2));
    }

    // ---------- state ----------
    let ALL = [];
    let FILTERED = [];
    let ACTIVE_KEY = "";
    let ACTIVE_COL = "";
    let sortKey = "Description";
    let sortDir = 1; // 1 asc, -1 desc

    // ---------- map build ----------
    function buildMap(){
      // East should be I (top) .. A (bottom)
      const east  = colRange("A","I").reverse();
      const south = colRange("J","O");
      const west  = colRange("P","X");

      const eastEl = $("eastCols");
      const southEl = $("southCols");
      const westEl = $("westCols");
      eastEl.innerHTML = "";
      southEl.innerHTML = "";
      westEl.innerHTML = "";

      for(const c of south) southEl.appendChild(makeColBtn(c));
      for(const c of east)  eastEl.appendChild(makeColBtn(c));
      for(const c of west)  westEl.appendChild(makeColBtn(c));

      refreshColDots();
    }

    function makeColBtn(letter){
      const btn = document.createElement("div");
      btn.className = "colBtn";
      btn.dataset.col = letter;
      btn.title = `Column ${letter}`;
      btn.textContent = letter;

      const dot = document.createElement("div");
      dot.className = "dot";
      btn.appendChild(dot);

      btn.addEventListener("click", () => {
        setActiveColumn(letter);
        ACTIVE_KEY = "";
        renderTable();
      });

      return btn;
    }

    function setActiveColumn(letter){
      ACTIVE_COL = letter || "";
      document.querySelectorAll(".colBtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.col === ACTIVE_COL);
      });
    }

    function refreshColDots(){
      const colsWithItems = new Set(ALL.map(x => x.Column).filter(Boolean));
      document.querySelectorAll(".colBtn").forEach(b=>{
        b.classList.toggle("hasItems", colsWithItems.has(b.dataset.col));
      });
    }

    // ---------- table ----------
    function applyFilter(){
      const q = normalizeText($("q").value).toLowerCase();
      if(!q){
        FILTERED = ALL.slice();
      }else{
        FILTERED = ALL.filter(it=>{
          const hay = `${it.Description} ${it.Location} ${it.Category}`.toLowerCase();
          return hay.includes(q);
        });
      }
      sortFiltered();
      $("countAll").textContent = ALL.length.toString();
      $("countNow").textContent = FILTERED.length.toString();
    }

    function sortFiltered(){
      const key = sortKey;
      const dir = sortDir;
      const get = (it)=>{
        if(key==="Location") return it.Location || "";
        if(key==="Category") return it.Category || "";
        return it.Description || "";
      };
      FILTERED.sort((a,b)=>{
        const A = get(a).toLowerCase();
        const B = get(b).toLowerCase();
        if(A<B) return -1*dir;
        if(A>B) return  1*dir;
        return 0;
      });
      renderSortArrows();
    }

    function renderSortArrows(){
      $("arItem").textContent = (sortKey==="Description") ? (sortDir===1 ? "▲" : "▼") : "";
      $("arLoc").textContent  = (sortKey==="Location")    ? (sortDir===1 ? "▲" : "▼") : "";
      $("arCat").textContent  = (sortKey==="Category")    ? (sortDir===1 ? "▲" : "▼") : "";
    }

    function renderTable(){
      const tb = $("rows");
      tb.innerHTML = "";

      for(const it of FILTERED){
        const tr = document.createElement("tr");
        const key = `${it.ChestID}|||${it.Description}`;
        tr.classList.toggle("active", key === ACTIVE_KEY);

        const tdItem = document.createElement("td");
        tdItem.textContent = it.Description;

        const tdLoc = document.createElement("td");
        tdLoc.className = "mono";
        tdLoc.textContent = it.Location;

        const tdCat = document.createElement("td");
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = it.Category || "—";
        tdCat.appendChild(tag);

        tr.appendChild(tdItem);
        tr.appendChild(tdLoc);
        tr.appendChild(tdCat);

        tr.addEventListener("click", ()=> selectItem(it));
        tb.appendChild(tr);
      }
    }

    function selectItem(it){
      ACTIVE_KEY = `${it.ChestID}|||${it.Description}`;
      setActiveColumn(it.Column);

      $("selDesc2").textContent  = it.Description || "—";
      $("selChest2").textContent = it.Location || "—";
      renderLocator(it.ChestID, "locator2");

      renderTable();
    }

    // ---------- loading ----------
    async function tryLoadServerCSV(){
      try{
        const res = await fetch("items.csv", { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const txt = await res.text();
        const parsed = parseCSV(txt);
        const items = rowsToItems(parsed);
        if(!items.length) throw new Error("No items parsed.");
        setItems(items);
        showNotice("", false);
        showPicker(false);
        return true;
      }catch(err){
        showNotice("Server load failed (likely local file mode). Select items.csv from disk.", true);
        showPicker(true);
        return false;
      }
    }

    function showNotice(msg, show){
      const n = $("notice");
      n.textContent = msg || "";
      n.style.display = show ? "block" : "none";
    }

    function showPicker(show){
      $("pickerRow").classList.toggle("show", !!show);
    }

    function setItems(items){
      ALL = items;
      FILTERED = items.slice();

      buildMap();
      refreshColDots();
      applyFilter();
      renderTable();

      // Clear center panel
      $("selDesc2").textContent = "—";
      $("selChest2").textContent = "—";
      renderLocator("", "locator2");
    }

    async function loadLocalFile(){
      const f = $("file").files?.[0];
      if(!f) return;
      const txt = await f.text();
      const parsed = parseCSV(txt);
      const items = rowsToItems(parsed);
      setItems(items);
      showNotice("Local CSV loaded.", true);
    }

    // ---------- init ----------
    function wireUI(){
      $("q").addEventListener("input", ()=>{
        applyFilter();
        renderTable();
      });

      $("clear").addEventListener("click", ()=>{
        $("q").value = "";
        setActiveColumn("");
        ACTIVE_KEY = "";
        applyFilter();
        renderTable();
      });

      $("loadBtn").addEventListener("click", loadLocalFile);

      $("thItem").addEventListener("click", ()=>{
        if(sortKey==="Description") sortDir *= -1;
        sortKey="Description";
        sortFiltered();
        renderTable();
      });
      $("thLoc").addEventListener("click", ()=>{
        if(sortKey==="Location") sortDir *= -1;
        sortKey="Location";
        sortFiltered();
        renderTable();
      });
      $("thCat").addEventListener("click", ()=>{
        if(sortKey==="Category") sortDir *= -1;
        sortKey="Category";
        sortFiltered();
        renderTable();
      });
    }

    (async function init(){
      wireUI();
      renderSortArrows();
      await tryLoadServerCSV();
    })();
  </script>
</body>
</html>
